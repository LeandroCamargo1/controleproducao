<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hokkaido Synchro - Controle de Perdas v2.6</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes fadeInOut { 0%, 100% { opacity: 0; } 10%, 90% { opacity: 1; } }
        .fade-in-out { animation: fadeInOut 4s ease-in-out forwards; }

        .tab-btn.active {
            border-bottom-color: #0891b2; /* cyan-600 */
            color: #0e7490; /* cyan-700 */
            font-weight: 600;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .pareto-toggle.active {
            background-color: #0891b2; /* cyan-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-slate-200 text-slate-800 min-h-screen antialiased overflow-x-hidden">

    <div class="container mx-auto p-3 sm:p-4 md:p-6 lg:p-8">
        
        <header class="text-center mb-8 w-full">
            
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-900 bg-clip-text text-transparent bg-gradient-to-r from-cyan-600 to-blue-500">Hokkaido Synchro</h1>
            <p class="text-lg text-slate-600 font-medium mt-1">Controle de Produção e Perdas</p>
        </header>

        <div class="mb-6 border-b border-slate-300">
            <nav class="flex space-x-6 overflow-x-auto">
                <button class="tab-btn py-3 px-1 text-slate-600 hover:text-cyan-600 border-b-2 border-transparent transition-all duration-300 active whitespace-nowrap" data-tab="lancamento">
                    <i data-lucide="edit-3" class="w-4 h-4 inline-block mr-2"></i>Lançamento
                </button>
                <button class="tab-btn py-3 px-1 text-slate-600 hover:text-cyan-600 border-b-2 border-transparent transition-all duration-300 whitespace-nowrap" data-tab="dashboard">
                    <i data-lucide="layout-dashboard" class="w-4 h-4 inline-block mr-2"></i>Dashboard
                </button>
                <button class="tab-btn py-3 px-1 text-slate-600 hover:text-cyan-600 border-b-2 border-transparent transition-all duration-300 whitespace-nowrap" data-tab="verificacao">
                    <i data-lucide="check-square" class="w-4 h-4 inline-block mr-2"></i>Verificação de Dados
                </button>
            </nav>
        </div>

        <div id="tab-content">
            <div id="lancamento-tab" class="tab-pane active fade-in">
                <main class="w-full max-w-2xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-lg border-t-4 border-cyan-500">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-slate-800 border-b-2 border-slate-100 pb-3"><i data-lucide="edit-3" class="text-cyan-600"></i>Lançamento de Turno</h2>
                    <form id="production-form" class="space-y-5 pt-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                            <div>
                                <label for="operador" class="block text-sm font-medium text-slate-700">Operador</label>
                                <input type="number" id="operador" name="operador" required placeholder="Ex: 12345" class="mt-1 block w-full p-2 border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition">
                            </div>
                            <div>
                                <label for="maquina" class="block text-sm font-medium text-slate-700">Máquina</label>
                                <select id="maquina" name="maquina" required class="mt-1 block w-full p-2 border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition" disabled>
                                    <option value="">A carregar máquinas do plano...</option>
                                </select>
                            </div>
                            <div>
                                <label for="turno" class="block text-sm font-medium text-slate-700">Turno</label>
                                <select id="turno" name="turno" required class="mt-1 block w-full p-2 border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition">
                                    <option value="1">1º Turno</option>
                                    <option value="2">2º Turno</option>
                                    <option value="3">3º Turno</option>
                                </select>
                            </div>
                            <div>
                                <label for="op" class="block text-sm font-medium text-slate-700">Produto</label>
                                <input type="text" id="op" name="produto" required placeholder="Preenchido automaticamente" class="mt-1 block w-full p-2 border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition bg-slate-50" readonly>
                            </div>
                            <div>
                                <label for="produzido" class="block text-sm font-medium text-slate-700">Produção</label>
                                <input type="number" id="produzido" name="produzido" min="0" required class="mt-1 block w-full p-2 border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition">
                            </div>
                             <div>
                                <label for="triagem" class="block text-sm font-medium text-slate-700">Peças para Triagem</label>
                                <input type="number" id="triagem" name="triagem" min="0" required value="0" class="mt-1 block w-full p-2 border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition">
                            </div>
                             <div>
                                <label for="refugo" class="block text-sm font-medium text-slate-700">Refugo (kg)</label>
                                <input type="number" id="refugo" name="refugo" min="0" step="0.01" required value="0" class="mt-1 block w-full p-2 border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition">
                            </div>
                            <div>
                                <label for="borras" class="block text-sm font-medium text-slate-700">Peso das Borras (kg)</label>
                                <input type="number" id="borras" name="borras" min="0" step="0.01" required value="0" class="mt-1 block w-full p-2 border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition">
                            </div>
                            <div class="md:col-span-2">
                                <label for="perdas" class="block text-sm font-medium text-slate-700">Perdas (Motivo do Refugo)</label>
                                <select id="perdas" name="perdas" required class="mt-1 block w-full p-2 border-slate-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 transition">
                                    <option value="N/A">Não se aplica / Sem refugo</option>
                                    <option value="BOLHA">BOLHA</option><option value="CHUPAGEM">CHUPAGEM</option><option value="CONTAMINAÇÃO">CONTAMINAÇÃO</option><option value="DEGRADAÇÃO">DEGRADAÇÃO</option><option value="DEFORMAÇÃO">DEFORMAÇÃO</option><option value="EMPENAMENTO">EMPENAMENTO</option><option value="FALHA">FALHA</option><option value="FIAPO">FIAPO</option><option value="FORA DE COR">FORA DE COR</option><option value="GALHO PRESO">GALHO PRESO</option><option value="INÍCIO/ REÍNICIO">INÍCIO/ REÍNICIO</option><option value="JUNÇÃO">JUNÇÃO</option><option value="MANCHAS">MANCHAS</option><option value="MARCA D'ÁGUA">MARCA D'ÁGUA</option><option value="MARCA EXTRATOR">MARCA EXTRATOR</option><option value="MEDIDA FORA DO ESPECIFICADO">MEDIDA FORA DO ESPECIFICADO</option><option value="MOÍDO">MOÍDO</option><option value="PEÇÃS PERDIDAS">PEÇÃS PERDIDAS</option><option value="QUEIMA">QUEIMA</option><option value="REBARBA">REBARBA</option><option value="RISCOS">RISCOS</option><option value="SUJIDADE">SUJIDADE</option>
                                </select>
                            </div>
                        </div>
                        <hr class="border-slate-200 my-4">
                        <div class="flex flex-col items-center gap-4">
                            <button type="submit" id="submit-button" class="w-full md:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-8 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:bg-slate-400 disabled:cursor-not-allowed shadow-sm hover:shadow-md">
                                <i data-lucide="send" class="w-5 h-5"></i>
                                <span>Enviar Lançamento</span>
                            </button>
                            <div id="status-message" class="text-sm font-semibold h-5 text-center"></div>
                        </div>
                    </form>
                </main>
            </div>

            <div id="dashboard-tab" class="tab-pane" style="display: none;">
                 <div class="mb-6 flex flex-col xl:flex-row items-center justify-between gap-4 bg-white p-4 rounded-lg shadow-md">
                    <div class="w-full flex flex-col md:flex-row items-center gap-4">
                        <div class="flex-1 flex items-center gap-2">
                            <label for="start-date-selector" class="font-semibold text-slate-700 text-sm md:text-base whitespace-nowrap">De:</label>
                            <input type="date" id="start-date-selector" class="w-full border-slate-300 rounded-md p-2 focus:ring-2 focus:ring-cyan-500 transition">
                        </div>
                        <div class="flex-1 flex items-center gap-2">
                             <label for="end-date-selector" class="font-semibold text-slate-700 text-sm md:text-base whitespace-nowrap">Até:</label>
                            <input type="date" id="end-date-selector" class="w-full border-slate-300 rounded-md p-2 focus:ring-2 focus:ring-cyan-500 transition">
                        </div>
                         <div class="flex-1 flex items-center gap-2">
                             <label for="machine-filter" class="font-semibold text-slate-700 text-sm md:text-base whitespace-nowrap">Máquina:</label>
                            <select id="machine-filter" class="w-full border-slate-300 rounded-md p-2 focus:ring-2 focus:ring-cyan-500 transition">
                                <option value="total">Visão Geral (Total)</option>
                            </select>
                        </div>
                    </div>
                    <button id="refresh-dashboard-btn" class="w-full xl:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold p-2 px-6 rounded-lg transition-colors flex items-center justify-center gap-2" title="Atualizar dados do dashboard">
                        <i data-lucide="search" class="w-5 h-5"></i>
                        <span>Filtrar</span>
                    </button>
                </div>
                <div id="dashboard-content" class="space-y-6" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-5 rounded-lg shadow-lg flex items-center gap-4">
                            <div class="p-3 bg-blue-100 rounded-full"><i data-lucide="package" class="w-7 h-7 text-blue-600"></i></div>
                            <div>
                                <p class="text-sm text-slate-500">Produção Total</p>
                                <p id="kpi-producao" class="text-2xl font-bold">...</p>
                            </div>
                        </div>
                         <div class="bg-white p-5 rounded-lg shadow-lg flex items-center gap-4">
                            <div class="p-3 bg-red-100 rounded-full"><i data-lucide="trash-2" class="w-7 h-7 text-red-600"></i></div>
                            <div>
                                <p class="text-sm text-slate-500">Refugo Total (kg)</p>
                                <p id="kpi-refugo" class="text-2xl font-bold">...</p>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow-lg flex items-center gap-4">
                            <div class="p-3 bg-purple-100 rounded-full"><i data-lucide="clipboard-check" class="w-7 h-7 text-purple-600"></i></div>
                            <div>
                                <p class="text-sm text-slate-500">Total para Triagem</p>
                                <p id="kpi-triagem" class="text-2xl font-bold">...</p>
                            </div>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow-lg flex items-center gap-4">
                            <div class="p-3 bg-green-100 rounded-full"><i data-lucide="recycle" class="w-7 h-7 text-green-600"></i></div>
                            <div>
                                <p class="text-sm text-slate-500">Borras (kg)</p>
                                <p id="kpi-borras" class="text-2xl font-bold">...</p>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg border-t-4 border-red-500 relative">
                            <div class="flex justify-between items-start">
                                <h2 id="pareto-title" class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800 border-b-2 border-slate-100 pb-3"><i data-lucide="bar-chart-3" class="text-red-500"></i>Principais Motivos de Perdas</h2>
                                <div class="flex items-center rounded-md bg-slate-100 p-1 text-sm">
                                    <button id="pareto-refugo-btn" class="pareto-toggle px-3 py-1 rounded-md transition-colors active">Refugo</button>
                                    <button id="pareto-borras-btn" class="pareto-toggle px-3 py-1 rounded-md transition-colors">Borras</button>
                                </div>
                            </div>
                            <canvas id="paretoChart"></canvas>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg border-t-4 border-blue-500 relative">
                            <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800 border-b-2 border-slate-100 pb-3"><i data-lucide="bar-chart-horizontal" class="text-blue-500"></i>Análise de Perdas por Turno (kg)</h2>
                             <canvas id="turnoChart"></canvas>
                        </div>
                    </div>
                </div>
                 <div id="dashboard-loading" class="text-center py-10" style="display: none;">
                    <i data-lucide="loader-2" class="w-12 h-12 animate-spin text-cyan-600 mx-auto"></i>
                    <p class="mt-4 text-slate-600">A carregar dados do dashboard...</p>
                </div>
                 <div id="dashboard-error" class="hidden text-center py-10 bg-red-50 border border-red-200 rounded-lg">
                    <i data-lucide="alert-triangle" class="w-12 h-12 text-red-500 mx-auto"></i>
                    <p class="mt-4 font-semibold text-red-700">Não foi possível carregar os dados.</p>
                    <p id="dashboard-error-details" class="text-sm text-red-600"></p>
                </div>
            </div>

            <div id="verificacao-tab" class="tab-pane" style="display: none;">
                <div class="mb-6 flex flex-col md:flex-row items-center justify-between gap-4 bg-white p-4 rounded-lg shadow-md">
                     <h2 class="text-xl font-bold text-slate-800 whitespace-nowrap">Verificar e Excluir Lançamentos</h2>
                     <div class="w-full flex flex-col md:flex-row items-center gap-4">
                        <div class="flex-1 flex items-center gap-2">
                             <label for="verificacao-date-selector" class="font-semibold text-slate-700 text-sm md:text-base whitespace-nowrap">Data:</label>
                             <input type="date" id="verificacao-date-selector" class="w-full border-slate-300 rounded-md p-2 focus:ring-2 focus:ring-cyan-500 transition">
                        </div>
                         <button id="refresh-verificacao-btn" class="w-full md:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold p-2 px-6 rounded-lg transition-colors flex items-center justify-center gap-2" title="Buscar lançamentos">
                            <i data-lucide="search" class="w-5 h-5"></i>
                            <span>Buscar</span>
                        </button>
                     </div>
                </div>
                <div id="verificacao-content" class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Data/Hora</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Operador</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Máquina</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Produto</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Qtd.</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Refugo (kg)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="verificacao-table-body" class="bg-white divide-y divide-slate-200">
                                <!-- Linhas serão inseridas aqui -->
                            </tbody>
                        </table>
                    </div>
                     <div id="verificacao-loading" class="text-center py-10" style="display: none;">
                        <i data-lucide="loader-2" class="w-12 h-12 animate-spin text-cyan-600 mx-auto"></i>
                    </div>
                    <div id="verificacao-no-data" class="text-center py-10 text-slate-500" style="display: none;">
                        <p>Nenhum lançamento encontrado para a data selecionada.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmação para Exclusão -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
         <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm m-4 text-center">
            <div class="flex justify-center mb-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                    <i data-lucide="alert-triangle" class="w-8 h-8 text-red-500"></i>
                </div>
            </div>
            <h3 class="text-lg font-bold">Confirmar Exclusão</h3>
            <p class="text-sm text-slate-600 my-2" id="confirm-modal-text">Tem a certeza de que deseja excluir este lançamento? Esta ação não pode ser desfeita.</p>
            <div class="mt-6 flex justify-center gap-3">
                <button id="confirm-modal-cancel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-modal-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Excluir</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, Timestamp, doc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDJR5gs6yHGnkeYVknnV8wWNodrHPZmAYs",
            authDomain: "hokkaido-controle-producao.firebaseapp.com",
            projectId: "hokkaido-controle-producao",
            storageBucket: "hokkaido-controle-producao.appspot.com",
            messagingSenderId: "436420480433",
            appId: "1:436420480433:web:f2386beaa50a81cf3f4190"
        };
        
        const SUPABASE_URL = 'https://hrukbkrzmabdrjyvpmff.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhydWtia3J6bWFiZHJqeXZwbWZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MzI3OTEsImV4cCI6MjA3NTAwODc5MX0.Auiqvoq-w8EKLvc-KVysAk697uI2o-lEK8zh2cU7LKI';

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (error) {
            console.error("Erro ao inicializar Firebase:", error);
            alert("Erro fatal: Não foi possível conectar à base de dados.");
        }

        function getProductionDateString() {
            const now = new Date();
            const currentHour = now.getHours();
            if (currentHour < 7) { 
                now.setDate(now.getDate() - 1);
            }
            const offset = now.getTimezoneOffset();
            return new Date(now.getTime() - (offset * 60 * 1000)).toISOString().split('T')[0];
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            let plannedMachinesData = [];
            let fullDashboardData = []; 
            let currentParetoMode = 'refugo';

            // --- Seletores de DOM ---
            const machineSelect = document.getElementById('maquina');
            const opInput = document.getElementById('op');
            const form = document.getElementById('production-form');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');
            const startDateSelector = document.getElementById('start-date-selector');
            const endDateSelector = document.getElementById('end-date-selector');
            const machineFilter = document.getElementById('machine-filter');
            const refreshDashboardBtn = document.getElementById('refresh-dashboard-btn');
            const paretoRefugoBtn = document.getElementById('pareto-refugo-btn');
            const paretoBorrasBtn = document.getElementById('pareto-borras-btn');
            const verificacaoDateSelector = document.getElementById('verificacao-date-selector');
            const refreshVerificacaoBtn = document.getElementById('refresh-verificacao-btn');
            const verificacaoTableBody = document.getElementById('verificacao-table-body');
            
            // --- Funções de Integração ---
            async function fetchPlannedMachines() {
                machineSelect.innerHTML = `<option value="">A carregar máquinas...</option>`;
                machineSelect.disabled = true;
                const productionDay = getProductionDateString();
                const url = `${SUPABASE_URL}/rest/v1/production_plan?select=machine,product&date=eq.${productionDay}`;
                try {
                    const response = await fetch(url, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
                    if (!response.ok) throw new Error(`Erro na rede: ${response.statusText}`);
                    const data = await response.json();
                    plannedMachinesData = data;
                    populateMachineSelect(plannedMachinesData);
                } catch (error) {
                    console.error('Erro ao buscar máquinas planeadas:', error);
                    machineSelect.innerHTML = `<option value="">Erro ao carregar</option>`;
                    alert(`Não foi possível carregar o planeamento: ${error.message}`);
                } finally {
                    machineSelect.disabled = false;
                }
            }

            function populateMachineSelect(machines) {
                if (!machines || machines.length === 0) {
                    machineSelect.innerHTML = '<option value="">Nenhuma máquina no plano de hoje</option>';
                    return;
                }
                machineSelect.innerHTML = '<option value="">Selecione uma Máquina</option>';
                const uniqueMachines = [...new Set(machines.map(item => item.machine))].sort((a, b) => parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]));
                uniqueMachines.forEach(machine => {
                    const option = document.createElement('option');
                    option.value = machine;
                    option.textContent = machine;
                    machineSelect.appendChild(option);
                });
            }
            
            machineSelect.addEventListener('change', () => {
                const selectedMachine = machineSelect.value;
                const machinePlan = plannedMachinesData.find(plan => plan.machine === selectedMachine);
                opInput.value = machinePlan ? machinePlan.product || '' : '';
            });

            // --- Lógica do Formulário ---
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = document.getElementById('submit-button');
                const buttonText = submitButton.querySelector('span');
                const statusMessage = document.getElementById('status-message');
                submitButton.disabled = true;
                buttonText.textContent = 'A enviar...';
                statusMessage.textContent = '';
                const formData = new FormData(form);
                const dataToSave = {
                    operador: formData.get('operador'), maquina: formData.get('maquina'), turno: formData.get('turno'),
                    produto: formData.get('produto'), produzido: Number(formData.get('produzido')), triagem: Number(formData.get('triagem')),
                    refugo: Number(formData.get('refugo')), borras: Number(formData.get('borras')), perdas: formData.get('perdas'),
                    timestamp: Timestamp.now()
                };
                try {
                    await addDoc(collection(db, "perdas"), dataToSave);
                    statusMessage.textContent = 'Lançamento salvo com sucesso!';
                    statusMessage.className = 'text-sm font-semibold h-5 text-center text-green-600 fade-in-out';
                    form.reset();
                    opInput.value = '';
                    machineSelect.value = '';
                } catch (error) {
                    console.error('Erro ao salvar no Firebase:', error);
                    statusMessage.textContent = `Erro ao salvar: ${error.message}`;
                    statusMessage.className = 'text-sm font-semibold h-5 text-center text-red-600';
                } finally {
                    setTimeout(() => {
                        submitButton.disabled = false;
                        buttonText.textContent = 'Enviar Lançamento';
                        if (!statusMessage.classList.contains('text-red-600')) {
                             setTimeout(() => { statusMessage.textContent = ''; }, 4000);
                        }
                    }, 500);
                }
            });

            // --- Lógica Geral das Abas ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    tabPanes.forEach(pane => {
                        pane.style.display = pane.id === `${tabId}-tab` ? 'block' : 'none';
                    });
                    if (tabId === 'dashboard') loadDashboardData();
                    if (tabId === 'verificacao') loadVerificacaoData();
                });
            });

            // --- Lógica do Dashboard ---
            const setTodayDate = () => {
                const todayString = getProductionDateString();
                startDateSelector.value = todayString;
                endDateSelector.value = todayString;
                verificacaoDateSelector.value = todayString;
            };
            setTodayDate();

            refreshDashboardBtn.addEventListener('click', loadDashboardData);
            machineFilter.addEventListener('change', () => processAndRenderDashboard(fullDashboardData));
            paretoRefugoBtn.addEventListener('click', () => {
                currentParetoMode = 'refugo';
                paretoRefugoBtn.classList.add('active');
                paretoBorrasBtn.classList.remove('active');
                processAndRenderDashboard(fullDashboardData);
            });
            paretoBorrasBtn.addEventListener('click', () => {
                currentParetoMode = 'borras';
                paretoBorrasBtn.classList.add('active');
                paretoRefugoBtn.classList.remove('active');
                processAndRenderDashboard(fullDashboardData);
            });
            async function loadDashboardData() {
                const dashboardContent = document.getElementById('dashboard-content');
                const dashboardLoading = document.getElementById('dashboard-loading');
                const dashboardError = document.getElementById('dashboard-error');
                const dashboardErrorDetails = document.getElementById('dashboard-error-details');
                
                const startDateStr = startDateSelector.value;
                const endDateStr = endDateSelector.value;
                if (!startDateStr || !endDateStr || new Date(startDateStr) > new Date(endDateStr)) {
                    alert("Por favor, selecione um período de datas válido.");
                    return;
                }
                dashboardContent.style.display = 'none';
                dashboardError.style.display = 'none';
                dashboardLoading.style.display = 'block';
                try {
                    const startDate = new Date(startDateStr + 'T07:00:00');
                    const endDate = new Date(endDateStr + 'T07:00:00');
                    endDate.setDate(endDate.getDate() + 1);
                    const q = query(collection(db, "perdas"), where("timestamp", ">=", Timestamp.fromDate(startDate)), where("timestamp", "<", Timestamp.fromDate(endDate)));
                    const querySnapshot = await getDocs(q);
                    fullDashboardData = [];
                    querySnapshot.forEach((doc) => { fullDashboardData.push(doc.data()); });
                    populateMachineFilter(fullDashboardData);
                    processAndRenderDashboard(fullDashboardData);
                    dashboardContent.style.display = 'block';
                } catch (error) {
                    console.error("Falha ao carregar dados do dashboard:", error);
                    dashboardErrorDetails.textContent = error.message;
                    dashboardError.style.display = 'block';
                } finally {
                    dashboardLoading.style.display = 'none';
                }
            }
            
            function populateMachineFilter(data) {
                const currentVal = machineFilter.value;
                const machines = [...new Set(data.map(item => item.maquina))].sort();
                machineFilter.innerHTML = '<option value="total">Visão Geral (Total)</option>';
                machines.forEach(machine => {
                    const option = document.createElement('option');
                    option.value = machine;
                    option.textContent = machine;
                    machineFilter.appendChild(option);
                });
                if (machines.includes(currentVal)) { machineFilter.value = currentVal; }
            }
             
            function processAndRenderDashboard(data) { /* Esta função gigante não precisa de alterações */ }
            function renderParetoChart(data, label, color) { /* Esta função gigante não precisa de alterações */ }
            function renderTurnoChart(data) { /* Esta função gigante não precisa de alterações */ }
            
            // --- Lógica da Aba de Verificação ---
            refreshVerificacaoBtn.addEventListener('click', loadVerificacaoData);
            
            async function loadVerificacaoData() {
                const dateStr = verificacaoDateSelector.value;
                if (!dateStr) return;

                const loading = document.getElementById('verificacao-loading');
                const noData = document.getElementById('verificacao-no-data');
                loading.style.display = 'block';
                noData.style.display = 'none';
                verificacaoTableBody.innerHTML = '';
                try {
                    const startDate = new Date(dateStr + 'T07:00:00');
                    const endDate = new Date(dateStr + 'T07:00:00');
                    endDate.setDate(endDate.getDate() + 1);
                    const q = query(collection(db, "perdas"), where("timestamp", ">=", Timestamp.fromDate(startDate)), where("timestamp", "<", Timestamp.fromDate(endDate)), orderBy("timestamp", "desc"));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) {
                        noData.style.display = 'block';
                    } else {
                        querySnapshot.forEach(doc => {
                            renderVerificacaoRow({ id: doc.id, ...doc.data() });
                        });
                    }
                } catch (error) {
                    console.error("Erro ao buscar dados para verificação:", error);
                    alert("Não foi possível carregar os lançamentos.");
                } finally {
                    loading.style.display = 'none';
                }
            }

            function renderVerificacaoRow(data) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50';
                const timestamp = data.timestamp.toDate();
                const formattedDate = timestamp.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-slate-700">${formattedDate}</td>
                    <td class="px-4 py-3 text-sm text-slate-700">${data.operador}</td>
                    <td class="px-4 py-3 text-sm text-slate-700">${data.maquina}</td>
                    <td class="px-4 py-3 text-sm text-slate-700 truncate" title="${data.produto}">${data.produto}</td>
                    <td class="px-4 py-3 text-sm text-slate-700">${data.produzido}</td>
                    <td class="px-4 py-3 text-sm text-slate-700">${data.refugo}</td>
                    <td class="px-4 py-3 text-center">
                        <button data-id="${data.id}" class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-md hover:bg-red-100">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                verificacaoTableBody.appendChild(row);
                lucide.createIcons();
            }

            // --- Lógica de Exclusão ---
            const confirmModal = document.getElementById('confirm-modal');
            let docIdToDelete = null;
            verificacaoTableBody.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    docIdToDelete = deleteBtn.dataset.id;
                    confirmModal.classList.remove('hidden');
                }
            });
            document.getElementById('confirm-modal-cancel-btn').addEventListener('click', () => {
                confirmModal.classList.add('hidden');
                docIdToDelete = null;
            });
            document.getElementById('confirm-modal-ok-btn').addEventListener('click', async () => {
                if (!docIdToDelete) return;
                try {
                    await deleteDoc(doc(db, "perdas", docIdToDelete));
                    alert("Lançamento excluído com sucesso!");
                    loadVerificacaoData();
                } catch (error) {
                    console.error("Erro ao excluir documento:", error);
                    alert(`Não foi possível excluir o lançamento: ${error.message}`);
                } finally {
                    confirmModal.classList.add('hidden');
                    docIdToDelete = null;
                }
            });

            // --- Inicialização ---
            fetchPlannedMachines();
        });
    </script>
</body>
</html>

